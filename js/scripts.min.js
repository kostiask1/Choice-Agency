let json = []
const errorDuration = 4000
let visible = false

$.fn.isVisible = function () {
    var elementTop = $(this).offset().top
    var elementBottom = elementTop + $(this).outerHeight()

    var viewportTop = $(window).scrollTop()
    var viewportBottom = viewportTop + $(window).height()

    return elementBottom > viewportTop && elementTop < viewportBottom
}

fetch("./db.json")
    .then((response) => response.json())
    .then((data) => {
        json = data
        ready()
    })

function ready() {
    if (window.innerWidth > 768) {
        $(window).on("resize scroll", function () {
            if ($("form button").isVisible()) {
                if (visible) {
                    $(window).off("resize scroll")
                }
                $(".form_input_wrapper,.countries,.checkbox").addClass("fadeIn")
                visible = true
            }
        })
    }
    $.mask.definitions["z"] = "[0-9]"
    $("#phone").mask("+ zzzzzzzz?zzzzz", {
        placeholder: "",
        autoclear: true,
    })
    $(".select2")
        .select2({
            minimumResultsForSearch: -1,
            data: json,
        })
        .on("select2:open", function () {
            $(".select2").addClass("active")
        })
        .on("select2:select", function (e) {
            let el = json.find((item) => item.id == $(this).val())
            $.mask.definitions["9"] = false
            $("#phone")
                .mask(el.dial_code + "zzzzzzzz?zzzzz", {
                    placeholder: "",
                    autoclear: true,
                })
                .addClass("active")

            $("#phone").val(el.dial_code)
        })
        .on("select2:close", function () {
            if (!!$(this).val()) {
                $(".select2").addClass("active")
                $(this).removeClass("error")
            } else {
                $(".select2").removeClass("active")
            }
        })
    $(".form_input_wrapper input").on("mouseleave keyup", function () {
        if (!!$(this).val()) {
            $(this).addClass("active")
            $(this).removeClass("error")
        } else {
            $(this).removeClass("active")
        }
    })
    $("form").submit(function (e) {
        e.preventDefault()
        $("#terms").removeClass("error")
        let data = $(this).serializeArray()
        if (!$("#terms").is(":checked")) {
            $("#terms").addClass("error")
            setTimeout(() => $("#terms").removeClass("error"), errorDuration)
        }
        data.forEach((key) => {
            key = key.name
            const el = $(`#${key}`)
            if (!el.val()) {
                addError(el)
            }
            switch (key) {
                case "name":
                    checkLength(el)
                    break
                case "surname":
                    checkLength(el)
                    break
                case "password":
                    checkPassword(el)
                    break
                case "password_confirm":
                    checkPassword(el)
                    break
                default:
                    return
            }
        })
    })
    const checkLength = (el) => {
        let condition = el.val().length > 2 ? true : false
        !condition ? addError(el) : removeError(el)
    }
    const checkPassword = (el) => {
        var formatSpecChar = /[`!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/
        //            ^                                       ^
        let hasSpecialChar = formatSpecChar.test(el.val())
        if (
            hasSpecialChar &&
            /\d/.test(el.val()) &&
            /[a-zA-Z]/.test(el.val())
        ) {
            let condition = $("#password").val() == el.val()
            !condition ? addError(el) : removeError(el)
        } else {
            addError(el)
        }
    }
    const addError = (el) => {
        el.addClass("error")
        setTimeout(() => removeError(el), errorDuration)
    }
    const removeError = (el) => {
        return el.removeClass("error")
    }
    $("#terms").on("change", function (e) {
        if ($(this).is(":checked")) {
            removeError($(this))
        }
    })
}
